AmCharts.Editor.ajax=function(options){options=jQuery.extend({url:AmCharts.Editor.CONSTANT.URL_API,crossDomain:true,method:'POST',dataType:'json',xhrFields:{'withCredentials':true}},options||{});jQuery.ajax(options);}
AmCharts.Editor.hexToRgb=function(hex,alpha){var result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return result?{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16),a:alpha||1}:null;}
AmCharts.Editor.modal=function(options){if(typeof options==='object'||options=='show'){jQuery(AmCharts.Editor.SELECTORS.modal).data('bs.modal',false).find('.modal-content').html('');}
jQuery('.modal-backdrop').remove();jQuery(AmCharts.Editor.SELECTORS.modal).modal(options);}
AmCharts.Editor.log=function(type){if(AmCharts.Editor.DEBUG===true){console.log(type,arguments[1]);}}
AmCharts.Editor.getMSG=function(key,lang){return AmCharts.Editor.I18N[key]||'Undefined message: '+ key;}
AmCharts.Editor.loadChart=function(chart_id,callback){AmCharts.Editor.ajax({data:{chart_id:chart_id,action:'amcharts_editor_get_chart'},complete:callback});}
AmCharts.Editor.saveDraft=function(){if(AmCharts.Editor.current.chart.chart_id){AmCharts.Editor.ajax({data:{action:'amcharts_editor_save_chart',chart_id:AmCharts.Editor.current.chart.chart_id,code:JSON.stringify(AmCharts.Editor.current.cfg),css:JSON.stringify(AmCharts.Editor.current.css),public:AmCharts.Editor.current.chart.public,draft:'1'},complete:function(transport){var response=transport.responseJSON||{error:true};jQuery.extend(AmCharts.Editor.current.chart,response);if(!response.error){AmCharts.Editor.changedConfig(true);jQuery.router.go('/'+ response.chart_id+'/edit/draft/');}else{AmCharts.Editor.log('error',response.message||'Something went wrong!');}}});}else{AmCharts.Editor.log('error','invoke saving draft; no chart id');}}
AmCharts.Editor.saveFork=function(){AmCharts.Editor.ajax({data:{action:'amcharts_editor_save_chart',chart_id:'',type:AmCharts.Editor.chartType,title:'copy of '+ AmCharts.Editor.current.chart.title,description:AmCharts.Editor.current.chart.description,code:JSON.stringify(AmCharts.Editor.current.cfg),template:JSON.stringify(AmCharts.Editor.current.tpl),css:JSON.stringify(AmCharts.Editor.current.css)},complete:function(transport){var response=transport.responseJSON||{error:true};jQuery.extend(AmCharts.Editor.current.chart,response);if(!response.error){AmCharts.Editor.current.chart.title='copy of '+ AmCharts.Editor.current.chart.title;AmCharts.Editor.changedConfig(true);AmCharts.Editor.getUserCharts();jQuery.router.go('/'+ response.chart_id+'/edit/');}else{AmCharts.Editor.log('error',response.message||'Something went wrong!');}}});}
AmCharts.Editor.saveState=function(chart_id,flag){AmCharts.Editor.ajax({data:{action:'amcharts_editor_save_chart',chart_id:chart_id,public:flag},complete:function(transport){var response=transport.responseJSON||{error:true};if(!response.error){if(chart_id==AmCharts.Editor.current.chart.chart_id){AmCharts.Editor.current.chart.public=flag=='1';}
AmCharts.Editor.getUserCharts();}else{AmCharts.Editor.log('error','couldnt toggle flag');}}});}
AmCharts.Editor.saveCSS=function(){AmCharts.Editor.ajax({data:{action:'amcharts_editor_save_chart',chart_id:AmCharts.Editor.current.chart.chart_id||'',code:JSON.stringify(AmCharts.Editor.current.cfg),css:JSON.stringify(AmCharts.Editor.current.css),public:1},complete:function(transport){var response=transport.responseJSON||{error:true};if(!response.error){AmCharts.Editor.current.chart.public=true;msg='Saved CSS CFG';}else{msg=response.message||'Something went wrong!';}
AmCharts.Editor.log('info',msg);}});}
AmCharts.Editor.deleteChart=function(chart_id){if(confirm('Confirm to delete chart')){if(AmCharts.Editor.current.user.loading){return false;}
AmCharts.Editor.current.user.loading=true;AmCharts.Editor.ajax({data:{action:'amcharts_editor_delete_chart',chart_id:chart_id},complete:function(transport){var response=transport.responseJSON||{error:true};AmCharts.Editor.current.user.loading=false;if(!response.error){AmCharts.Editor.getUserCharts();}else{AmCharts.Editor.log('error','removing chart: '+ chart_id);}}});}else{jQuery.router.go('/');}}
AmCharts.Editor.updateUserNav=function(){jQuery(AmCharts.Editor.SELECTORS.menu).find('li').each(function(){var disabled=false;if(jQuery(this).is('.am-menu-save, .am-menu-save-draft, .am-menu-fork, .am-menu-share')){disabled=AmCharts.Editor.current.user.error||AmCharts.Editor.current.user.login_url;if(jQuery(this).is('.am-menu-save-draft')){jQuery(this)[!disabled&&AmCharts.Editor.current.chart.chart_id&&AmCharts.Editor.current.user.changedConfig?'removeClass':'addClass']('disabled');}else if(jQuery(this).is('.am-menu-fork, .am-menu-share')){jQuery(this)[!disabled&&AmCharts.Editor.current.chart.chart_id?'removeClass':'addClass']('disabled');}else{jQuery(this)[disabled?'addClass':'removeClass']('disabled');}}});jQuery(window).trigger('changed.am.user.nav');}
AmCharts.Editor.updateUserBadge=function(){var msg='You have '+AmCharts.Editor.current.user.chart_count+' saved chart';var username=jQuery('.am-user-name');var usercharts=jQuery('.am-user-charts');jQuery(username).html(AmCharts.Editor.current.user.name||'');if(AmCharts.Editor.current.user.chart_count>0){jQuery(usercharts).text(AmCharts.Editor.current.user.chart_count||'0');jQuery(usercharts).each(function(){jQuery(this).parent().off().tooltip('destroy').addClass('btn-usercharts');if(!jQuery(this).parents('.modal').length){jQuery(usercharts).parent().on('click',function(e){e.stopPropagation();e.preventDefault();AmCharts.Editor.current.user.showChartList=true;AmCharts.Editor.modal({remote:AmCharts.Editor.CONSTANT.URL_BASE+'static/tpl/modal-chart-new.tpl?'+ AmCharts.Editor.CONSTANT.RND_KEY});});jQuery(this).parent().tooltip({title:AmCharts.Editor.current.user.chart_count==1?msg:msg+'s',placement:'bottom'});}});}
jQuery(window).trigger('changed.am.user.badge');}
AmCharts.Editor.getUser=function(){AmCharts.Editor.log('info','get user data');function updateUser(fromCache){AmCharts.Editor.updateUserNav();AmCharts.Editor.updateUserBadge();if(AmCharts.Editor.current.user.name){jQuery('.navbar-signin').addClass('hidden');jQuery('.navbar-user').removeClass('hidden');jQuery('.navbar-user .dropdown-menu').load(AmCharts.Editor.CONSTANT.URL_BASE+'static/tpl/dropdown-login-active.tpl?'+ AmCharts.Editor.CONSTANT.RND_KEY);AmCharts.Editor.getUserCharts();}else{jQuery('.navbar-signin').removeClass('hidden');jQuery('.navbar-user').addClass('hidden');jQuery('.navbar-signin .dropdown-menu').load(AmCharts.Editor.CONSTANT.URL_BASE+'static/tpl/dropdown-login-signin.tpl?'+ AmCharts.Editor.CONSTANT.RND_KEY,function(){if(jQuery('.app-section-'+ AmCharts.Editor.current.section+' .modal-backdrop-login').length){jQuery(this).find('iframe').attr('src',AmCharts.Editor.CONSTANT.URL_AMCHARTS+'sign-in/editor/?redirect_to='+ location.protocol+ AmCharts.Editor.CONSTANT.URL_BASE+'auth/done/?'+ AmCharts.Editor.CONSTANT.RND_KEY).data('loaded',true);}});jQuery('.app-landing-usercharts').html('');}}
if(AmCharts.Editor.current.user.id||AmCharts.Editor.current.user.gather){if(!AmCharts.Editor.current.user.gather){updateUser(true);}
return;}
AmCharts.Editor.current.user.gather=true;AmCharts.Editor.ajax({data:{action:'amcharts_editor_get_current_user'},complete:function(transport){var response=transport.responseJSON||{error:true};jQuery.extend(AmCharts.Editor.current.user,response);AmCharts.Editor.DEFAULTS.current.user=jQuery.extend({},AmCharts.Editor.current.user);jQuery(window).trigger('changed.am.user.data');if(!response.error&&response.id>0){AmCharts.Editor.current.user.login_url=false;}else{AmCharts.Editor.current.user={error:true};AmCharts.Editor.current.list.total_count=0;AmCharts.Editor.current.list.charts=[];AmCharts.Editor.log('error','could not receive user data');}
AmCharts.Editor.current.user.gather=false;updateUser();}});}
AmCharts.Editor.getUserCharts=function(parameters){AmCharts.Editor.log('info','get user charts');AmCharts.Editor.ajax({data:jQuery.extend({action:'amcharts_editor_get_chart_list'},parameters||{}),complete:function(transport){var response=transport.responseJSON||{error:true};if(!response.error){var containerTabs=jQuery(AmCharts.Editor.SELECTORS.modal+' .nav');var containerHTML=jQuery(AmCharts.Editor.SELECTORS.modal+' .tab-content');jQuery.extend(AmCharts.Editor.current.list,response);AmCharts.Editor.updateUserBadge();if(containerTabs.length&&containerHTML.length){var itemLink=jQuery('.am-group-mysavedcharts');var itemContainer=jQuery('#am-group-mysavedcharts');if(AmCharts.Editor.current.user.showChartList){AmCharts.Editor.current.user.showChartList=false;itemLink.tab('show');}
itemLink.attr('data-toggle','tab').tab().parent().removeClass('disabled');jQuery(itemContainer).load(AmCharts.Editor.CONSTANT.URL_BASE+'static/tpl/modal-user-charts.tpl?'+ AmCharts.Editor.CONSTANT.RND_KEY);}else{jQuery('.app-landing-usercharts').load(AmCharts.Editor.CONSTANT.URL_BASE+'static/tpl/landing-user-charts.tpl?'+ AmCharts.Editor.CONSTANT.RND_KEY);}}else{AmCharts.Editor.log('info','No user charts available');}
jQuery(window).trigger('changed.am.user.charts');}});}
AmCharts.Editor.updateIframe=function(css){jQuery('.am-menu-signin').removeClass('loading').removeClass('loading-dark');jQuery('iframe').css(css);}
AmCharts.Editor.updatePagination=function(){var tmpList=jQuery('.am-charts-pagination').html('');var badges=Math.ceil(AmCharts.Editor.current.list.total_count/AmCharts.Editor.current.list.number);if(badges>1){jQuery('.app-section, .modal-body').animate({scrollTop:0},{duration:250});var tmpItem=jQuery('<li></li>').appendTo(tmpList);var tmpLink=jQuery('<a></a>').attr('href','#').appendTo(tmpItem);var tmpTitle=jQuery('<i></i>').addClass('ui-icon ui-icon-triangle-1-w');tmpLink.html(tmpTitle);tmpItem.data('offset',AmCharts.Editor.current.list.offset-AmCharts.Editor.current.list.number);if(!AmCharts.Editor.current.list.offset){tmpItem.addClass('disabled');}
tmpLink.on('click',function(e){e.preventDefault();if(!jQuery(this).parent().hasClass('disabled')){AmCharts.Editor.getUserCharts({offset:jQuery(this).parent().data('offset')});}});for(var badge=0;badge<badges;badge++){var tmpItem=jQuery('<li></li>').appendTo(tmpList);var tmpLink=jQuery('<a></a>').attr('href','#').appendTo(tmpItem);var tmpTitle=badge+1;tmpItem.data('offset',badge*AmCharts.Editor.current.list.number);tmpLink.text(tmpTitle).on('click',function(e){e.preventDefault();AmCharts.Editor.getUserCharts({offset:jQuery(this).parent().data('offset')});});if(AmCharts.Editor.current.list.offset==badge*AmCharts.Editor.current.list.number){tmpItem.addClass('active');}};var tmpItem=jQuery('<li></li>').appendTo(tmpList);var tmpLink=jQuery('<a></a>').attr('href','#').appendTo(tmpItem);var tmpTitle=jQuery('<i></i>').addClass('ui-icon ui-icon-triangle-1-e');tmpLink.html(tmpTitle);tmpItem.data('offset',AmCharts.Editor.current.list.offset+AmCharts.Editor.current.list.number);if(AmCharts.Editor.current.list.offset+AmCharts.Editor.current.list.number>AmCharts.Editor.current.list.total_count){tmpItem.addClass('disabled');}
tmpLink.on('click',function(e){e.preventDefault();if(!jQuery(this).parent().hasClass('disabled')){AmCharts.Editor.getUserCharts({offset:jQuery(this).parent().data('offset')});}});}}
AmCharts.Editor.updateSection=function(name){var section=jQuery('.app-section-'+ name);jQuery(document.body).removeClass(function(index,css){return(css.match(/\bbody-\S+/g)||[]).join(' ');}).addClass('body-'+name);if(section.length){AmCharts.Editor.current.section=name;jQuery('.app-section').addClass('hidden');jQuery(section).removeClass('hidden');jQuery(window).trigger('changed.am.section',section);}else{AmCharts.Editor.log('error','no such section have been found');}}
AmCharts.Editor.backToDefaults=function(){AmCharts.Editor.log('info','back to defaults');AmCharts.Editor.chart={};AmCharts.Editor.cfg={};AmCharts.Editor.dataProvider=[];AmCharts.Editor.dataFields=[];AmCharts.Editor.DEFAULTS.current.user={};AmCharts.Editor.DEFAULTS.current.list={};AmCharts.Editor.DEFAULTS.current.chart={};AmCharts.Editor.DEFAULTS.current.cfg={};jQuery.extend(AmCharts.Editor.current,jQuery.extend({},AmCharts.Editor.DEFAULTS.current));}
AmCharts.Editor.parseJSON=function(jsonString){jsonString=jsonString.replace(/\\(?!\\[a-zA-Z"']+)/g,"");jsonString=JSON.parse(jsonString,function(k,v){if(v=="Not set"){v=undefined;}
return v;});return jsonString;}
AmCharts.Editor.avoidCaching=function(){window.clearTimeout(window.lala);window.lala=setInterval(function(){AmCharts.Editor.CONSTANT.RND_KEY=Number(new Date());},1000);}
AmCharts.Editor.finalizeConfig=function(){AmCharts.Editor.current.cfg.hideCredits=true;}
AmCharts.Editor.JSON={stringify:function(a,b,c){return JSON.stringify(a,function(k,v){if(typeof v==="function"){return v+"";}
return v;},b,c);},parse:function(str){return JSON.parse(str,function(k,v){var type=typeof v;var tmp;if(type==="string"){tmp=eval("["+v+"]");if(tmp.length&&typeof tmp[0]==="function"){v=tmp[0];}}
return v;});}}